name: Cleanup - Destroy GCP Resources

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm deletion of all resources'
        required: true
        type: string
      skip_confirmation:
        description: 'Skip interactive confirmation (dangerous!)'
        required: false
        type: boolean
        default: false

env:
  GCP_PROJECT_ID: todoapp-autoscaling-demo
  GCP_REGION: us-central1
  GCP_ZONE: us-central1-a
  CLUSTER_NAME: todoapp-autoscaling-cluster

jobs:
  validate-input:
    name: Validate Destruction Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Check confirmation input
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "‚ùå ERROR: You must type 'destroy' to confirm resource deletion"
            echo "You typed: '${{ github.event.inputs.confirm }}'"
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

      - name: Display warning
        run: |
          echo "‚ö†Ô∏è  WARNING: This will destroy the following resources:"
          echo "  - GKE Cluster: ${{ env.CLUSTER_NAME }}"
          echo "  - VPC Network and Subnet"
          echo "  - All Kubernetes workloads and data"
          echo "  - Load Balancers and associated resources"
          echo ""
          echo "Project: ${{ env.GCP_PROJECT_ID }}"
          echo "Region: ${{ env.GCP_REGION }}"

  cleanup:
    name: Destroy All Resources
    runs-on: ubuntu-latest
    needs: validate-input
    environment: 
      name: cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: List resources before cleanup
        run: |
          echo "üìä Current GKE Clusters:"
          gcloud container clusters list --project=${{ env.GCP_PROJECT_ID }} || echo "No clusters found"
          
          echo ""
          echo "üåê Current VPC Networks:"
          gcloud compute networks list --project=${{ env.GCP_PROJECT_ID }} || echo "No networks found"
          
          echo ""
          echo "üíæ Current Persistent Disks:"
          gcloud compute disks list --project=${{ env.GCP_PROJECT_ID }} || echo "No disks found"

      - name: Run Ansible cleanup
        run: |
          if [ "${{ github.event.inputs.skip_confirmation }}" == "true" ]; then
            # Skip interactive confirmation
            ansible-playbook -i ToDoApp/ansible/inventories/gcp/hosts.yml ToDoApp/ansible/cleanup.yml \
              -e "gcp_project_id=${{ env.GCP_PROJECT_ID }}" \
              -e "gcp_region=${{ env.GCP_REGION }}" \
              -e "gcp_zone=${{ env.GCP_ZONE }}" \
              -e "gke_cluster_name=${{ env.CLUSTER_NAME }}" \
              -e "confirm_user_input=yes" \
              -v
          else
            # This won't work well in CI as it requires interactive input
            # Consider modifying cleanup.yml to accept environment variable
            echo "yes" | ansible-playbook -i ToDoApp/ansible/inventories/gcp/hosts.yml ToDoApp/ansible/cleanup.yml \
              -e "gcp_project_id=${{ env.GCP_PROJECT_ID }}" \
              -e "gcp_region=${{ env.GCP_REGION }}" \
              -e "gcp_zone=${{ env.GCP_ZONE }}" \
              -e "gke_cluster_name=${{ env.CLUSTER_NAME }}" \
              -v
          fi
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY_FILE }}

      - name: Verify cleanup
        run: |
          echo "üìä Remaining GKE Clusters:"
          gcloud container clusters list --project=${{ env.GCP_PROJECT_ID }} || echo "‚úÖ No clusters found"
          
          echo ""
          echo "üåê Remaining VPC Networks (excluding default):"
          gcloud compute networks list --project=${{ env.GCP_PROJECT_ID }} --filter="name!=default" || echo "‚úÖ No custom networks found"

      - name: Cleanup orphaned resources
        run: |
          echo "üßπ Checking for orphaned resources..."
          
          # Delete any remaining forwarding rules
          echo "Checking forwarding rules..."
          gcloud compute forwarding-rules list --project=${{ env.GCP_PROJECT_ID }} \
            --format="value(name,region)" | while read name region; do
            if [ -n "$name" ]; then
              echo "Deleting forwarding rule: $name"
              gcloud compute forwarding-rules delete "$name" --region="$region" --quiet || true
            fi
          done
          
          # Delete any remaining target pools
          echo "Checking target pools..."
          gcloud compute target-pools list --project=${{ env.GCP_PROJECT_ID }} \
            --format="value(name,region)" | while read name region; do
            if [ -n "$name" ]; then
              echo "Deleting target pool: $name"
              gcloud compute target-pools delete "$name" --region="$region" --quiet || true
            fi
          done
          
          # Delete any remaining disks
          echo "Checking persistent disks..."
          gcloud compute disks list --project=${{ env.GCP_PROJECT_ID }} \
            --format="value(name,zone)" | while read name zone; do
            if [ -n "$name" ]; then
              echo "Deleting disk: $name"
              gcloud compute disks delete "$name" --zone="$zone" --quiet || true
            fi
          done
          
          echo "‚úÖ Orphaned resources cleanup completed"
        continue-on-error: true

      - name: Create cleanup summary
        if: always()
        run: |
          echo "## üßπ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ‚úÖ Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Status: Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Cleanup encountered errors. Please check logs and verify resources manually." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remaining Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          gcloud container clusters list --project=${{ env.GCP_PROJECT_ID }} >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No clusters" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Notify cleanup status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Cleanup successful! All resources destroyed."
          else
            echo "‚ùå Cleanup failed! Please check the logs."
            exit 1
          fi

  # Job to verify billing impact
  cost-check:
    name: Verify Cost Impact
    runs-on: ubuntu-latest
    needs: cleanup
    if: always()

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check for running resources
        run: |
          echo "üí∞ Checking for resources that may incur costs..."
          
          echo "GKE Clusters:"
          gcloud container clusters list --project=${{ env.GCP_PROJECT_ID }} || echo "None"
          
          echo ""
          echo "Compute Instances:"
          gcloud compute instances list --project=${{ env.GCP_PROJECT_ID }} || echo "None"
          
          echo ""
          echo "Load Balancers:"
          gcloud compute forwarding-rules list --project=${{ env.GCP_PROJECT_ID }} || echo "None"
          
          echo ""
          echo "Persistent Disks:"
          gcloud compute disks list --project=${{ env.GCP_PROJECT_ID }} || echo "None"
          
          echo ""
          echo "‚úÖ If all sections show 'None', no resources are incurring costs"
