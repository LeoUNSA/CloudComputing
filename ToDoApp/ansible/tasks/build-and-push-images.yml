---
# Tareas para construir y subir imÃ¡genes Docker a GCR
- name: Set image variables
  ansible.builtin.set_fact:
    backend_image: "{{ docker_registry }}/todoapp-backend:{{ image_tag }}"
    frontend_image: "{{ docker_registry }}/todoapp-frontend:{{ image_tag }}"

- name: Configure Docker to use gcloud as credential helper
  command: gcloud auth configure-docker --quiet
  changed_when: false

- name: Build backend Docker image
  command: >
    docker build 
    -t {{ backend_image }}
    -f backend/Dockerfile
    backend/
  args:
    chdir: "{{ playbook_dir }}/.."
  register: backend_build
  changed_when: true

- name: Build frontend Docker image
  command: >
    docker build 
    -t {{ frontend_image }}
    -f frontend/Dockerfile
    frontend/
  args:
    chdir: "{{ playbook_dir }}/.."
  register: frontend_build
  changed_when: true

- name: Push backend image to GCR
  command: docker push {{ backend_image }}
  changed_when: true

- name: Push frontend image to GCR
  command: docker push {{ frontend_image }}
  changed_when: true

- name: Display pushed images
  debug:
    msg:
      - "Backend Image: {{ backend_image }}"
      - "Frontend Image: {{ frontend_image }}"
